syntax = "proto3";

package envoy.extensions.filters.http.local_ratelimit.v3;

import "envoy/config/core/v3/base.proto";
import "envoy/type/v3/http_status.proto";
import "envoy/type/v3/token_bucket.proto";

import "udpa/annotations/status.proto";
import "udpa/annotations/versioning.proto";
import "validate/validate.proto";

option java_package = "io.envoyproxy.envoy.extensions.filters.http.local_ratelimit.v3";
option java_outer_classname = "LocalRateLimitProto";
option java_multiple_files = true;
option (udpa.annotations.file_status).package_version_status = ACTIVE;

// [#protodoc-title: Local Rate limit]
// Local Rate limit :ref:`configuration overview <config_http_filters_local_rate_limit>`.
// [#extension: envoy.filters.http.local_ratelimit]

// [#next-free-field: 11]
message LocalRateLimit {
  option (udpa.annotations.versioning).previous_message_type =
      "envoy.config.filter.http.local_rate_limit.v2.LocalRateLimit";

  // The global_switch used to control enable or disable limit feature.
  bool global_switch = 1;
  
  // The dry_run filed used to control the rate limit mode.
  // if enable the dry run mode, requests processing rate is not limited and only record log. 
  bool dry_run = 2;
    
  // This field allows to send a HTTP response status code to the downstream client other
  // than 429 (TooManyRequests) when the request has been rate limited.
  type.v3.HttpStatus status = 3;
  
  // This field allows to send a HTTP response body to the downstream client
  // when the request has been rate limited.
  string body = 4;

  // The token bucket configuration to use for rate limiting requests that are processed by this
  // filter. Each request processed by the filter consumes a single token. If the token is available,
  // the request will be allowed. If no tokens are available, the request will receive the configured
  // rate limit status.
  //
  // .. note::
  //   It's fine for the token bucket to not be set for the global configuration, but it must be set
  //   for the per route configuration.
  //
  // .. note::
  //   When using per route configuration, the bucket becomes unique to that route.
  //
  // .. note::
  //   In the current implementation the token bucket's :ref:`fill_interval
  //   <envoy_api_field_type.v3.TokenBucket.fill_interval>` must be >= 50ms to avoid too aggressive
  //   refills.
  type.v3.TokenBucket token_bucket = 5;

  // This uniquely identifies a specific local rate limit configuration (e.g.: when using per route
  // rate limiters). It will be used to construct the
  // :ref:`runtime keys <config_http_filters_local_rate_limit_runtime>` that enable and enforce
  // the corresponding local rate limiter.
  string route_key = 6 [(validate.rules).string = {min_bytes: 1}];

  // Specifies a list of HTTP headers that should be added to each response for requests that
  // have been rate limited.
  repeated config.core.v3.HeaderValueOption response_headers_to_add = 10
      [(validate.rules).repeated = {max_items: 10}];
}
